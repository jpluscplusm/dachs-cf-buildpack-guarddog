#!/usr/bin/ruby

require 'net/http'
require 'fileutils'

def download(host, path, destination)
  Net::HTTP.start(host) do |http|
      resp = http.get(path)
      open(destination, 'wb') do |file|
          file.write(resp.body)
      end
  end

  puts "Download of #{host}#{path} to #{destination} finished"
end

app_dir = ARGV[0]
cache_dir = ARGV[1]

FileUtils.touch(File.join(app_dir, '.guarddog'))

destination = File.join(app_dir, 'haproxy')
download('s3-eu-west-1.amazonaws.com', '/dachs-haproxy-build/haproxy', destination)

destination = File.join(cache_dir, 'nginx.tgz')
download('buildpacks.cloudfoundry.org', '/concourse-binaries/nginx/nginx-1.11.3-linux-x64.tgz', destination)

system("cd #{app_dir}; tar -xvf #{destination}")